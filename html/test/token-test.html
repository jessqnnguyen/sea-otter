<!--

	The Following HTML file exists to demonstrate the client's interaction with the authentication system.
	The tokens are saved locally to the cookies, and new token's can be generated by inputting the correct password
	into the passwordfield.
	
	The page uses cross-domain AJAX to make the requests, sending the data though POST.

-->
<html>
	<head>
		<meta name="Access-Control-Allow-Origin" content="*"></meta>
	</head>
	<body>
		<form id="passwordForm">
			<input type="password" name="passwordField"/>
			<input type="submit" value="submit password" id="testbutton"/>
		</form>
		
		<button id="useToken">Use Token</button>
		<button id="deleteAll">Delete all Tokens</button>
	</body>
	
	<script>
		//get all the elements
		var passwordForm = document.getElementById("passwordForm");
		var tokenButton = document.getElementById("useToken");
		var deleteAllButton = document.getElementById("deleteAll");
		
		//shorthand for the password input
		var password = passwordForm['passwordField'];
		
		//when the user submits the password
		//this represents when the user is signing in for the first time to authorize their computer
		passwordForm.onsubmit = function() {
			//create a new AJAX request
			var request = new XMLHttpRequest();
			//add a function on state change
			request.onreadystatechange = function() {
				
				//only continue if the request is completed
				if (request.readyState !== XMLHttpRequest.DONE) {
					return;
				}
				//parse the response data from JSON
				var response = JSON.parse(request.response);
				
				//if the server repors success on the action
				if(response.passwordSuccess == true) {
				
					AddDebugElement("token is " + response.token);
					//set the token to the responses's token
					document.cookie = "token=" + response.token;
				}
				else {
					AddDebugElement("invalid password");
				}
			}
			//send the data to the api
			request.open("POST","http://127.0.0.1:82/v1/auth/new-token.php");
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send("password="+password.value);
			//this stops the page from reloading on submit
			return false;
		}
		
		//when the user clicks the 'use token' button
		//this represents a standar user action that needs to be authorized
		tokenButton.onclick = function() {
			//create a new AJAX request
			var request = new XMLHttpRequest();
			//add a function on state change
			request.onreadystatechange = function() {
				//only continue if the request is completed
				if (request.readyState !== XMLHttpRequest.DONE) {
					return;
				}
				//parse the response data from JSON
				var response = JSON.parse(request.response);
				//if the server repors success on the action
				if(response.success == true) {
				
					AddDebugElement("token consumed and regenerated");
					
					document.cookie = "token=" + response.token;
				}
				else {
					AddDebugElement("token was not accepted");
				}
			}
			//send the data to the api
			request.open("POST","http://127.0.0.1:82/v1/auth/consume-token.php");
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send(document.cookie);
		}
		
		deleteAllButton.onclick = function() {
		
			var request = new XMLHttpRequest();
			//add a function on state change
			request.onreadystatechange = function() {
				//only continue if the request is completed
				if (request.readyState !== XMLHttpRequest.DONE) {
					return;
				}
				//parse the response data from JSON
				var response = JSON.parse(request.response);
				//if the server repors success on the action
				if(response.success == true) {
					AddDebugElement("all tokens deleted");
				}
				else {
					AddDebugElement("token was not accepted");
				}
			}
			//send the data to the api
			request.open("POST","http://127.0.0.1:82/v1/auth/delete-all-tokens.php");
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send(document.cookie);
		}
		
		//This handy utility appends a new paragraph element
		//to the body of the document, containing whatever you input as the parameter as text
		function AddDebugElement(content) {
		
			var element = document.createElement("p");
			
			element.innerHTML = content;
			
			document.body.appendChild(element);
			
		}
	</script>
</html>